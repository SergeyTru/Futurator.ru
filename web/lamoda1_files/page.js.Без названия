/*
 RequireJS text 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 Available via the MIT or new BSD license.
 see: http://github.com/requirejs/text for details
*/

define("ii/widget/tip",[],function(){"use strict";function l(e){if(i.getLength()){var t=i.get();t&&t.isVisible&&($(e.target).closest(s).length||t.close())}}var e="ttip",t=LMDA.Utils.getEventsNamesMap(e),n={disabled:"ii-blocked",container:e,wrapper:e+"__wrapper",arrow:e+"__arrow",content:e+"__content",btnClose:e+"__close",visible:e+"_visible",contentInfo:e+"__content_info",contentError:e+"__content_error"},r=['<div class="',n.container,'">','<div class="',n.wrapper,'">','<div class="',n.arrow,'"></div>','<div class="',n.content,'" data-easter="🐰"></div>',"</div>","</div>"].join(""),i=new LMDA.Utils.ModalsStack,s=$(r).hide().attr("tabindex","-1").appendTo(LMDA.$body||"body").on(t.click,'[data-action="close"]',function(e){return e.preventDefault(),i.get().close()}),o=s.find([".",n.content].join("")),u=s.find([".",n.arrow].join("")),a=s.find([".",n.wrapper].join("")),f=s.get(0);return LMDA.$document.on(t.keydown,function(e){e.keyCode===27&&i.getLength()&&i.get().close()}),LMDA.$window.on([t.resize,t.scroll].join(" "),function(){i.getLength()&&i.get().updatePosition()}),LMDA.Events.on(LMDA.Events.CLOSE_TOOLTIPS,function(){i.getLength()&&i.get().close()}),LMDA.Views.BaseView.extend({defaults:{evt:t,cn:{hidden:"ttip_hidden",visible:"ttip_visible"},cnArrowDirections:{top:"ttip__arrow_t",right:"ttip__arrow_r",bottom:"ttip__arrow_b",left:"ttip__arrow_l"},arrow:{size:12},offset:10,place:"top",preset:null},initialize:function(){return this.init&&this.init(),this},init:function(){var e=this;return this.o.offset+=this.o.arrow.size*.5,this.isMouseHovered=!1,this.isVisible=!1,this.isDisabled=!1,this.currentPosition=null,this.CN_ARROW_DIRECTIONS=[this.o.cnArrowDirections.top,this.o.cnArrowDirections.right,this.o.cnArrowDirections.bottom,this.o.cnArrowDirections.left].join(" "),s.on(this.o.evt.mouseenter,function(){e.isMouseHovered=!0,e.trigger("mouseenter")}).on(this.o.evt.mouseleave,function(){e.isMouseHovered=!1,e.trigger("mouseleave")}),this},updatePosition:function(){return this.isVisible&&this.setPosition(),this},setContent:function(t,r){return this.isDisabled&&this.enable(),this.trigger("beforeRender",this,o),s.removeClass().addClass([n.container,e+"_"+this.o.preset].join(" ")),o.removeClass().addClass([n.content,r||""].join(" ")).html(t),this.tipBounds=LMDA.Utils.getHiddenElementSizes(s),this.trigger("afterRender",this,o),this},close:function(){return this.isVisible?(LMDA.$document.off(t.click,l),i.pop(),this.trigger("beforeClose"),s.hide().removeClass().addClass(n.container),o.html(""),this.isMouseHovered=!1,this.isVisible=!1,this.trigger("close"),this):this},open:function(e,r){e=e.get?e.get(0):e;if(e.offsetWidth===0&&e.offsetHeight===0)return;this.currentTarget=e,this.currentPosition=r;if(this.isVisible)return this._offOutsideClick&&this._offOutsideClick(s,this.close,this),this.updatePosition(),this._onOutsideClick&&this._onOutsideClick(s,this.close,this),this;this.isVisible=!0;if(i.getLength()){var u=this,a=i.get();if(a!==this)return a.once("close",function(){u.open.apply(u,arguments)}),a.close(),this}return i.push(this),LMDA.$document.off(t.click,l),window.setTimeout(function(){LMDA.$document.on(t.click,l)},0),this.trigger("beforeOpen",o),this.setPosition(),s.css("z-index",LMDA.Utils.pageManager.currentZindex+10).show().addClass(n.visible),this.trigger("open",o),this},show:function(e,t,n){return this.setContent(t),this.open(e||this.elTrigger,n)},error:function(e,t,r){this.setContent(t,n.contentError);if(e){var i=$(e),s=this;this.once("open",function(){s.once("close",function(){i.removeClass("is_invalid")}),i.addClass("is_invalid").one("blur.Tooltip",function(){s.close()})})}return this.open(e||this.elTrigger,r)},info:function(e,t,r){return this.setContent(t,n.contentInfo),this.open(e||this.elTrigger,r)},bindHover:function(e){function a(){r&&window.clearTimeout(r);if(n)return;n=!0,e.cb?e.cb(u):u(e.content)}function f(o){r=window.setTimeout(function(){t.isMouseHovered?(n=!1,t.once("mouseleave",function(){t.close(),s.removeClass(i)})):(n=!1,t.close(),s.removeClass(i))},e.msDelayHide)}e.msDelayHide=e.msDelayHide||100;var t=this,n=!1,r=null,i="i_hovered",s=e.element,o=s.get(0),u=function(n){if(!n)return!1;var r=_.isFunction(n)?n():n;s.addClass(i),t.setContent(r),t.open(o,e.place)};return s.off([this.o.evt.mouseenter,this.o.evt.mouseleave].join(" ")).on(this.o.evt.mouseenter,a).on(this.o.evt.mouseleave,f),this},invertPosition:function(e){switch(e[0]){case"top":e[0]="bottom";break;case"bottom":e[0]="top"}return e},setPosition:function(){if(!this.isVisible||_.isEmpty(this.tipBounds))return this;var e=LMDA.Utils.getElementBounds(this.currentTarget),t=LMDA.Utils.getViewportBounds(),n=this.currentPosition.split("-"),r=this.suggestByBounds(e,this.currentPosition);if(r.top-t.top<0||t.bottom-r.bottom<0)n=this.invertPosition(n),r=this.suggestByBounds(e,n.join("-"));var i="";switch(n[0]){case"top":i=this.o.cnArrowDirections.bottom;break;case"left":i=this.o.cnArrowDirections.right;break;case"right":i=this.o.cnArrowDirections.left;break;case"bottom":i=this.o.cnArrowDirections.top}u.removeClass(this.CN_ARROW_DIRECTIONS).addClass(i);var o={left:"",top:""};switch(n[1]){case"top":o.top=this.o.arrow.size*2;break;case"bottom":o.top=this.tipBounds.height-this.o.arrow.size*2;break;case"left":o.left=this.o.arrow.size*2;break;case"right":o.left=this.tipBounds.width-this.o.arrow.size*2;break;default:}return u.css(o),s.css({left:r.left,top:r.top}),this},suggestByBounds:function(e,t){var n=e.left,r=e.top;switch(t){case"top":n+=e.hWidth-this.tipBounds.hWidth,r-=this.tipBounds.height;break;case"top-right":n+=e.width-this.tipBounds.width,r-=this.tipBounds.height;break;case"top-left":r-=this.tipBounds.height;break;case"bottom":n+=e.hWidth-this.tipBounds.hWidth,r+=e.height;break;case"bottom-right":n+=e.width-this.tipBounds.width+this.o.offset,r+=e.height;break;case"bottom-left":n-=this.o.offset,r+=e.height;break;case"right":n+=e.width,r+=e.hHeight-this.tipBounds.hHeight;break;case"right-top":n+=e.width,r-=this.o.offset;break;case"right-bottom":n+=e.width,r+=e.height-this.tipBounds.height+this.o.offset;break;case"left":n-=this.tipBounds.width,r+=e.hHeight-this.tipBounds.hHeight;break;case"left-top":n-=this.tipBounds.width,r-=this.o.offset;break;case"left-bottom":n-=this.tipBounds.width,r+=e.height-this.tipBounds.height+this.o.offset}return{left:n,top:r,right:n+this.tipBounds.width,bottom:r+this.tipBounds.height}},enable:function(){return o.removeClass(n.disabled),this.isDisabled=!1,this},disable:function(){return this.isDisabled=!0,o.addClass(n.disabled),this}})}),define("ii/page/upselling",[],function(){return LMDA.mixins.Upselling={getUpselling:function(e,t,n){var r=this;this.renderedCb=n,this.addedSku12=e,this.upsellingTemplate=t,this.upsellingRequest&&this.upsellingRequest.abort(),this.upsellingRequest=$.ajax({url:"/p/upselling/"+this.addedSku12+"/",dataType:"text",context:this,success:function(t){var n=$.parseJSON(t),i;n.status=="OK"?(i=_.find(this.items,function(e){return e.sku16==n.sku}),LMDA.Statistics.report("popup_cart","has_recommendations",{source:"popup_cart",sku:n.sku,sku_source:e}),!i&&this.showUpselling(n)):r.renderedCb&&r.renderedCb()}})},showUpselling:function(e){var t={url:LMDA.Utils.addUrlParam(e.url,"from","popup_cart_recos"),price:LMDA.Utils.formatPrice(e.price,LMDA.country.currency),name:e.name||"",brand:e.brand||"",image:e.image||"",sku:e.sku},n,r,i=this.upsellingTemplate(t);this.renderedCb?this.renderedCb(i):this.$(".cart-item_added").after(i),this.buttonPreloader=new LMDA.Utils.ButtonPreloader(this.$(".js-button-upselling-buy")),LMDA.Statistics.report("popup_cart","show_recommendations",{source:"popup_cart",sku:e.sku,sku_source:this.addedSku12}),r=this.$(".post-cart-add__animation-wrapper"),n=r.height(),r.css({height:"0",position:"static",visibility:"visible"}),r.animate({height:n+"px"})},buyUpselling:function(e){function n(e){t.removeClass("button_disabled"),this.buttonPreloader.stop()}function r(){this.buttonPreloader.stop(),this.trigger("buyUpsellingSuccess")}var t=$(e.currentTarget);t.addClass("button_disabled"),this.buttonPreloader.start(),$.when(LMDA.API.Cart.addToCart(t.data("sku"),{source:"popup_cart_recos",sku_source:this.addedSku12})).then(_.bind(r,this),_.bind(n,this))}},LMDA.mixins.Upselling}),define("text",["module"],function(e){var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,r=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,i="undefined"!=typeof location&&location.href,s=i&&location.protocol&&location.protocol.replace(/\:/,""),o=i&&location.hostname,u=i&&(location.port||void 0),a=[],f=e.config&&e.config()||{},l,c;return l={version:"2.0.1",strip:function(e){if(e){e=e.replace(n,"");var t=e.match(r);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:f.createXhr||function(){var e,n,r;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(n=0;3>n;n+=1){r=t[n];try{e=new ActiveXObject(r)}catch(i){}if(e){t=[r];break}}return e},parseName:function(e){var t=!1,n=e.indexOf("."),r=e.substring(0,n);return e=e.substring(n+1,e.length),n=e.indexOf("!"),-1!==n&&(t=e.substring(n+1,e.length),t="strip"===t,e=e.substring(0,n)),{moduleName:r,ext:e,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,n,r){var i=l.xdRegExp.exec(e),s;return i?(e=i[2],i=i[3],i=i.split(":"),s=i[1],i=i[0],(!e||e===t)&&(!i||i.toLowerCase()===n.toLowerCase())&&(!s&&!i||s===r)):!0},finishLoad:function(e,t,n,r){n=t?l.strip(n):n,f.isBuild&&(a[e]=n),r(n)},load:function(e,t,n,r){if(r.isBuild&&!r.inlineText)n();else{f.isBuild=r.isBuild;var a=l.parseName(e);r=a.moduleName+"."+a.ext;var c=t.toUrl(r),h=f.useXhr||l.useXhr;!i||h(c,s,o,u)?l.get(c,function(t){l.finishLoad(e,a.strip,t,n)},function(e){n.error&&n.error(e)}):t([r],function(e){l.finishLoad(a.moduleName+"."+a.ext,a.strip,e,n)})}},write:function(e,t,n,r){a.hasOwnProperty(t)&&(r=l.jsEscape(a[t]),n.asModule(e+"!"+t,"define(function () { return '"+r+"';});\n"))},writeFile:function(e,t,n,r,i){t=l.parseName(t);var s=t.moduleName+"."+t.ext,o=n.toUrl(t.moduleName+"."+t.ext)+".js";l.load(s,n,function(t){t=function(e){return r(o,e)},t.asModule=function(e,t){return r.asModule(e,o,t)},l.write(e,s,t,i)},i)}},"undefined"!=typeof process&&process.versions&&process.versions.node?(c=require.nodeRequire("fs"),l.get=function(e,t){var n=c.readFileSync(e,"utf8");0===n.indexOf("﻿")&&(n=n.substring(1)),t(n)}):l.createXhr()?l.get=function(e,t,n){var r=l.createXhr();r.open("GET",e,!0),f.onXhr&&f.onXhr(r,e),r.onreadystatechange=function(i){4===r.readyState&&(i=r.status,399<i&&600>i?(i=Error(e+" HTTP status: "+i),i.xhr=r,n(i)):t(r.responseText))},r.send(null)}:"undefined"!=typeof Packages&&(l.get=function(e,t){var n=new java.io.File(e),r=java.lang.System.getProperty("line.separator"),n=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(n),"utf-8")),i,s,o="";try{i=new java.lang.StringBuffer,(s=n.readLine())&&s.length()&&65279===s.charAt(0)&&(s=s.substring(1));for(i.append(s);null!==(s=n.readLine());)i.append(r),i.append(s);o=String(i.toString())}finally{n.close()}t(o)}),l}),define("text!ii/page/cart-tip/cart-tip.html",[],function(){return'<a href="/checkout/cart/" class="cart-tip__fake-link-to-cart  js-go-to-cart"></a>\n<div class="cart-tip__head">\n    <p class="cart-tip__head-title"><%= quantity %> <%= LMDA.Utils.pluralize(quantity, \'товар\', \'товара\', \'товаров\') %> на сумму <%= LMDA.Utils.formatPrice(total, LMDA.country.currency) %></p>\n    <% if (!LMDA.DATA.user.get(\'isLoggedIn\')) { %>\n        <p class="cart-tip__head-auth"><span>Авторизоваться</span> и сохранить список товаров</p>\n    <% } %>\n</div>\n<div class="cart-tip__items">\n    <% _.each(items, function(item) { %>\n        <div class="cart-item <%if (item.out_of_stock){%>cart-item_out<%}%>">\n            <a href="<%= item.url %>" class="cart-item__cell cart-item__cell_photo">\n                <img class="cart-item__photo cart-item__photo_small" src="<%= item.img %>">\n            </a>\n            <div class="cart-item__cell cart-item__cell_description">\n                <span class="cart-item__name"><%= item.title %> <b><%= item.brand %></b></span>\n                <br/>\n                <span class="cart-item__size">\n                    <% if (item.size && item.size !== \'unisize\') { %>\n                        <span>Размер: <%= item.size %> <%= LMDA.sizeSystem %> / <%= item.brand_size %> <%= item.brand_size_system %></span>\n                    <% } %>\n                </span>\n                <br/>\n                <div class="cart-item__quantity">\n                    <%= item.quantity %> шт.\n                </div>\n                <div class="cart-item__price">\n                    <% if (item.out_of_stock) { %>\n                        нет в наличии\n                    <% } else { %>\n                        <% if (item.original_price) { %>\n                            <s><%= LMDA.Utils.formatPrice(item.original_price, LMDA.country.currency) %></s>\n                            &nbsp;\n                            <span class="cart-item__new-price"><%= LMDA.Utils.formatPrice(item.price, LMDA.country.currency) %></span>\n                        <% } else { %>\n                            <%= LMDA.Utils.formatPrice(item.price, LMDA.country.currency)%>\n                        <% } %>\n                    <% } %>\n                </div>\n            </div>\n        </div>\n    <% }); %>\n</div>\n<div class="cart-tip__link-to-cart">\n    <a class="button button_l button_blue" href="/checkout/cart/">\n        <span class="button_title">Перейти в корзину</span>\n    </a>\n</div>\n'}),define("text!ii/page/cart-tip/cart-tip_upselling.html",[],function(){return'<div class="cart-tip__upselling">\n    <div class="cart-tip__title">Рекомендуем приобрести</div>\n    <div class="cart-item">\n        <a href="<%= url %>" class="cart-item__cell cart-item__cell_photo">\n            <img class="cart-item__photo cart-item__photo_small" src="<%= image %>">\n        </a>\n        <div class="cart-item__cell cart-item__cell_description">\n            <div class="cart-item__name"><%= name %> <b><%= brand %></b></div>\n            <div class="cart-item__price"><%= price %></div>\n            <div class="button button_<%= UI8038_exp %> js-button-upselling-buy" data-sku="<%= sku %>">\n                <span class="button__progress"></span>\n                Добавить к заказу\n            </div>\n        </div>\n    </div>\n</div>'}),define("ii/page/cart-tip/cart-tip",["ii/widget/tip","ii/page/upselling","text!ii/page/cart-tip/cart-tip.html","text!ii/page/cart-tip/cart-tip_upselling.html"],function(e,t,n,r){function i(e){e.$el&&e.$el.find(".cart-tip__items").off("scroll",e.beingScrolled),e.setElement(".ttip_cart"),e.$el.find(".cart-tip__items").on("scroll",e.beingScrolled)}var s=e.extend({place:"bottom",isRendered:!1,events:{"click .js-button-upselling-buy:not(.button_disabled)":"buyUpselling","click .cart-tip__head-auth":"openAuthForm","click .cart-tip__link-to-cart":"goToCart","click .js-go-to-cart":"goToCart"},initialize:function(){this.constructor.__super__.initialize.call(this),_.bindAll(this,"beingScrolled"),this.$target=$(".js-basket-button-title"),this.$target.on("mouseenter",_.bind(this.handleCart,this)),this.on("buyUpsellingSuccess",this.showCartTip,this),this.on("beforeClose",this.$el.off,this.$el),$(".js-user-nav").on("mouseenter",this.close,this),$(document).on("click",_.bind(this.close,this)),LMDA.Events.on(LMDA.Events.AUTH_SUCCESS,_.bind(this.getCart,this)),LMDA.Events.on(LMDA.Events.CART_ADD,_.bind(this.renderCartProduct,this))},handleCart:function(){!this.isRendered&&LMDA.user.cart?this.getCart():this.html&&this.showCartTip()},renderCartProduct:function(e){var t=this;this.isRendered=!1,LMDA.API.Cart.getCart().done(function(n){t.html=t.renderCartTip(n.data),LMDA.DATA.isExperimentOn("UI5315_Upselling2")&&t.getUpselling(e.product.sku12,_.template(r),function(e){e&&t.$(".cart-item").first().after(e)})})},showCartTip:function(){this.isVisible||(LMDA.Statistics.report("cart_tip","open"),this.beingScrolledIsTreggered=!1),this.show(this.$target,this.html,this.place),i(this),this.$el.on("click",function(e){e.stopPropagation()}),this.closeByTimeout()},closeDelay:150,closeByTimeout:function(){var e=this;this.$el.off("mouseenter mouseleave").on("mouseenter",function(){clearTimeout(e.timer)}).on("mouseleave",function(){e.timer=setTimeout(function(){e.close()},e.closeDelay)})},renderCartTip:function(e){return _.template(n,e)},openAuthForm:function(){LMDA.Events.trigger(LMDA.Events.OPEN_AUTH_FORM)},getCart:function(){var e=this;LMDA.API.Cart.getCart().done(function(t){t.data&&(e.html=e.renderCartTip(t.data),e.showCartTip()),e.isRendered=!0})},goToCart:function(){LMDA.Statistics.report("cart_tip","go_to_cart")},updatePosition:function(){},invertPosition:function(e){return e},beingScrolled:function(){this.beingScrolledIsTreggered||LMDA.Statistics.report("cart_tip","being_scrolled"),this.beingScrolledIsTreggered=!0}});return _.extend(s.prototype,t),s}),define("ii/widget/modal",[],function(){"use strict";var e=LMDA.$document||$(document),t=LMDA.$body||$(document.body),n="modal",r=LMDA.Utils.getEventsNamesMap("Modal"),i={container:"modal",wrapper:"modal__wrapper",holster:"modal__holster",content:"modal__content",layout:"modal__layout",btnClose:"modal__close",visible:"modal_visible",failed:"modal_failed"},s=['<div class="',i.container,'">','<div class="',i.wrapper,'">','<div class="',i.holster,'">','<div class="',i.content,'">','<div class="',i.btnClose,'" data-action="close" title="Закрыть"></div>','<div class="',i.layout,'"></div>',"</div>","</div>","</div>","</div>"].join(""),o=['<div class="txt-paragraph">','<div class="heading_l">Произошла ошибка</div>',"</div>",'<div class="button button_blue" data-action="close">','<span class="button__title">Закрыть</span>',"</div>"].join(""),u=new LMDA.Utils.ModalsStack;return e.on(r.keydown,function(e){e.keyCode===27&&u.getLength()&&u.get().close({byKeyDown:!0})}),LMDA.Views.BaseView.extend({defaults:{evt:r,sel:{},cn:{blocked:"ii-blocked"},cnPreset:""},initialize:function(){return this.init&&this.init(),this},init:function(){var e=this;return this.xhr=null,this.requestManager=new LMDA.Utils.RequestManager({onBeforeRequest:function(t){e.reset(),e.xhr=t,e.block(),e.open()},onAfterRequest:function(t){e.unblock()},onRequestFail:function(t){e.trigger("fail",t),e.$container.addClass(i.failed),e.$layout.html(o)},onRequestDone:function(t,n){e.trigger("done",t),e.xhr=null,e.render(n)}}),this.$container=$(s).hide().attr("tabindex","-1").appendTo(t),this.$content=this.$container.find([".",i.content].join("")),this.$layout=this.$content.find([".",i.layout].join("")),this.$holster=this.$container.find([".",i.holster].join("")),this.o.cnPreset&&this.$container.addClass([n,this.o.cnPreset].join("_")),this.o.noClose?this.$container.find([".",i.btnClose].join("")).remove():this.$holster.on(this.o.evt.click,function(t){var n=$(t.target);if(!n.hasClass(i.holster))return;return e.close()}),this.$wrapper=this.$container.find([".",i.wrapper].join("")).on(this.o.evt.click,'[data-action="reload"]',function(t){return t.preventDefault(),e.reload()}).on(this.o.evt.click,'[data-action="close"]',function(t){return t.preventDefault(),e.close()}),this.on("beforeClose",function(){e.requestManager.stop()}).on("close",function(){LMDA.Events.trigger("popup:toggle",!1)}).on("open",function(){LMDA.Events.trigger("popup:toggle",!0)}),this},open:function(){return this.trigger("beforeOpen"),this.$container.css("z-index",LMDA.Utils.pageManager.currentZindex+1).addClass(i.visible).show().scrollTop(0),this.trigger("open"),u.push(this),LMDA.Utils.pageManager.block(),this},close:function(e){return e&&e.byKeyDown&&this.o.noClose?this:(this.trigger("beforeClose"),this.$container.hide().removeClass(i.visible),this.trigger("close"),u.pop(),LMDA.Utils.pageManager.unblock(),this)},block:function(){return this.$content.hasClass(this.o.cn.blocked)?this:(this.$content.addClass(this.o.cn.blocked),this.trigger("block"),this)},unblock:function(){return this.$content.hasClass(this.o.cn.blocked)?(this.$content.removeClass(this.o.cn.blocked),this.trigger("unblock"),this):this},reload:function(){return this},reset:function(){return this.xhr&&this.xhr.abort(),this.$container.removeClass(i.failed),this.$layout.get(0).innerHTML="",this.trigger("reset"),this},render:function(e){return this.reset(),this.trigger("beforeRender",this,this.$layout),this.$layout.html(e||""),this.trigger("afterRender",this,this.$layout),this},load:function(e){return _.isEmpty(e)?this:this.requestManager.ajax.apply(this.requestManager,arguments)},setPreset:function(e){return e?(this.$container.addClass([n,e].join("_")),this):this}})}),define("text!ii/page/geodetection/geodetection_popup.html",[],function(){return'<form class="geo">\n    <div class="geo__img"></div>\n    <h3>Укажите ваш регион доставки:</h3>\n    <input class="text-field text-field_large" value="" type="text" placeholder="Введите название населённого пункта" />\n    <ul class="geo__suggest suggest__list">\n\n    </ul>\n    <div class="geo_title-for-default-cities">Например:</div>\n    <ul class="geo__default-cities">\n        <%= defaultCities %>\n    </ul>\n    <hr/>\n    <button class="button button_blue button_disabled geo__button-save"><span class="button__title">Сохранить</span></button>\n</form>'}),define("ii/page/geodetection/geodetection",["ii/widget/tip","ii/widget/modal","text!ii/page/geodetection/geodetection_popup.html"],function(e,t,n){var r=function(e){if(e)return _.compact([e.city,e.region]).join(", ")},i=_.template(n),s=function(e,t,n,r){LMDA.Utils.cookie.set("addrCity",encodeURIComponent([].join.call(arguments,"|",this)))},o=function(){var e=LMDA.Utils.cookie.get("addrCity");if(e){var t=decodeURIComponent(e).split("|");return{aoid:t[0],city:t[1],region:t[2],isChosen:t[3]}}},u=e.extend({preset:"geo",events:{"click .button_no":"popupOpen","click .button_ok":"saveLocation"},saveLocation:function(){var e=this.options.currentAddr;s(e.aoid,e.city,e.region,!0),this.close(!0),LMDA.Statistics.report("geo","tooltip","yes")},popupOpen:function(){this.trigger("popupOpen"),this.close(!0),LMDA.Statistics.report("geo","tooltip","no")},invertPosition:function(e){return e},close:function(e){e&&(this.constructor.__super__.close.call(this),$(".usp__item_usp-left").removeClass("geo__disable"))}}),a=t.extend({events:{"input input":"getSuggest","keydown input":"navigate","click input":"selectInput","click .geo__suggest li":"hideSuggest","blur input":"hideSuggest","focus input":"showSuggest","mouseenter .geo__suggest li":"selectAddr","click .geo__default-cities li":"setDefaultCity"},initialize:function(){var e=this;this.defaultCities=this.options.defaultCities,this.selectedAddr=this.options.defaultAddress,this.on("afterRender",function(){e.setElement(".geo"),e.$el.on("submit",function(t){t.preventDefault(),e.saveAddr()})}),this.constructor.__super__.initialize.call(this)},render:function(e){return this.constructor.__super__.render.call(this,i({defaultCities:this.formatSuggest(this.defaultCities)})),this},selectInput:function(e){e.currentTarget.select()},getSuggest:_.debounce(function(e){var t=$.trim($(e.currentTarget).val()),n=this;this.removeSelectedAddr(),this.requestSuggest(t),t?this.ajax.done(function(e){_.isEmpty(e)?(n.renderError("Проверьте написание и воспользуйтесь подсказкой"),n.hideSuggest()):(n.renderSuggest(e),n.renderDefaultCities(),n.showSuggest())}):(n.renderSuggest(),n.renderDefaultCities())},100),requestSuggest:function(e){var t=this;return this.ajax&&this.ajax.state()==="pending"&&this.ajax.abort(),this.ajax=$.get("/apix/suggest/?q="+e).fail(function(){t.renderError("Что-то пошло не так")}),this.ajax},renderError:function(e){this.$(".geo__default-cities").html('<span class="geo__error">'+e+"</span>"),this.$(".geo_title-for-default-cities").hide()},renderDefaultCities:function(){this.$(".geo__default-cities").html(this.formatSuggest(this.defaultCities)),this.$(".geo_title-for-default-cities").show()},formatSuggest:function(e){return _.map(e,function(e){return'<li data-aoid="'+e.aoid+'" class="suggest__item">'+r(e)+"</li>"}).join("")},renderSuggest:function(e){this.$(".geo__suggest").html(this.formatSuggest(e)),this.suggestResult=e},saveAddr:function(){var e=this.selectedAddr;e&&(s(e.aoid,e.city,e.region,!0),this.trigger("saveAddr",e),this.close(),LMDA.Statistics.report("geo","tooltip","city_select"))},showSuggest:function(){this.suggestResult&&(this.$(".geo__suggest").show(),this.isSuggestOpened=!0)},hideSuggest:function(){this.$(".geo__suggest").hide(),this.selectedAddr&&(this.$("input").val(r(this.selectedAddr)),this.renderDefaultCities()),this.isSuggestOpened=!1},setSelectedAddr:function(e){this.selectedAddr=e,this.$(".geo__button-save").removeClass("button_disabled")},removeSelectedAddr:function(){this.selectedAddr="",this.$(".geo__button-save").addClass("button_disabled")},selectAddr:function(e){var t=$(e.currentTarget);this.$(".suggest__item").removeClass("suggest__item_active").filter(t).addClass("suggest__item_active"),this.setSelectedAddr(this.suggestResult[t.index()]),this.selectedIndex=t.index(),this.renderDefaultCities()},setDefaultCity:function(e){var t=$(e.currentTarget),n=this;this.renderSuggest(),this.requestSuggest(t.text()).done(function(e){var i=_.findWhere(e,{aoid:t.data("aoid").toString()}),s={aoid:i.aoid,city:i.city,region:i.region,isChosen:!0};n.$("input").val(r(s)),n.setSelectedAddr(s),n.$(".geo__button-save").focus()})},navigate:function(e){var t=this,n=e.keyCode;if(!this.suggestResult)return;n==13&&this.selectedAddr&&(this.isSuggestOpened&&e.preventDefault(),this.hideSuggest());if(n==40||n==38)this.selectedIndex=this.selectedIndex===undefined?0:this.selectedIndex-(39-n),this.setSelectedAddr(this.suggestResult[this.selectedIndex]),this.selectedAddr||(this.selectedIndex=0,this.setSelectedAddr(this.suggestResult[this.selectedIndex])),this.$(".geo__suggest .suggest__item").removeClass("suggest__item_active").eq(this.selectedIndex).addClass("suggest__item_active"),this.$(".geo__suggest").animate({scrollTop:this.$(".geo__suggest .suggest__item_active")[0].offsetTop},100)}}),f=Backbone.View.extend({events:{"click .header__geo-trigger":"popupOpen"},initialize:function(){var e=this,t=o();this.defaultCities=this.$el.data("cities"),t?(this.render(t),t.isChosen||this.openTooltip(t),this.currentAddr=t):this.setCityByIP(),this.modal=new a({cnPreset:"geo",defaultCities:this.defaultCities,defaultAddress:t}),this.modal.on("saveAddr",function(t){e.currentAddr=t,e.render(t)})},setCityByIP:function(){var e=this;$.get("/apix/ipsearch/").done(function(t){var n=t[0];e.render(n),e.openTooltip(n),s(n.aoid,n.city,n.region),e.currentAddr=n}).fail(function(){e.render()})},render:function(e){e?this.$el.html('<span class="header__geo-trigger">Ваш регион доставки: <span>'+(e.city||e.region)+"</span></span>"):this.$el.html('<span class="header__geo-trigger">Укажите регион доставки</span>')},popupOpen:function(){this.modal.render(this.currentAddr).open(),this.tip&&this.tip.close(!0),LMDA.Statistics.report("geo","tooltip","open_popup")},openTooltip:function(e){if(LMDA.experiments.UI10212_geotooltip==="1")return;var t=this;this.tip=new u({preset:"geo",currentAddr:e}),$(".usp__item_usp-left").addClass("geo__disable"),this.tip.show(this.$(".header__geo-trigger span"),'<div><div class="button button_blue button_ok">Да, всё верно</div><div class="button button_outline button_outline_blue button_no">Нет, выбрать другой</div></div>',"bottom"),this.tip.setElement(".ttip_geo"),this.tip.on("popupOpen",function(){t.popupOpen()}),LMDA.Statistics.report("geo","tooltip","show")}});return f}),define("ii/page/share-button",[],function(){$(".share-button").on("click",function(e){var t=$(this).attr("href");if(t){e.preventDefault();var n=Math.floor((window.screen.width-780)*.5),r=Math.floor((window.screen.height-500)*.5),i=window.open(t,"popup",["width=780","height=500","top="+r,"left="+n,"directories=no","location=no","menubar=no","resizable=no","scrollbars=no","status=no","toolbar=no"].join(" ,"));return i.focus&&i.focus(),!1}})}),define("ii/page/page",["ii/page/cart-tip/cart-tip","ii/page/geodetection/geodetection","ii/page/share-button"],function(e,t){LMDA.DATA.isExperimentOn("UI9333")&&new e({preset:"cart"});var n=$(".header__geo");n.length&&new t({el:n})});