define("ii/product/dropdownPrice",[],function(){"use strict";function e(e){this.dropdown=e,this.product=e.product,this.getRecommendation()}function t(e){var t=this;return this.o={evt:LMDA.Utils.getEventsNamesMap("SuggestFitAnalytics"),sel:{trigger:".js-widget-fitanalytics",triggerText:".ii-select__note-text"},dataProps:{textEmpty:"dict-empty",textFilled:"dict-filled"},widgetPath:"//widget.fitanalytics.com/widget.js"},this.dropdown=e,this.product=e.product,this.$elTrigger=this.dropdown.views.buy.$viewport.find(this.o.sel.trigger).hide().on(this.o.evt.click,function(){t.widget.open(),LMDA.Statistics.report("fitanalytics","open",{product:t.product.toJSON()})}),this.$elTriggerText=this.$elTrigger.find(this.o.sel.triggerText),this.matchedOption=-1,this.needsCartAdding=!1,this.textEmpty=this.$elTrigger.data(this.o.dataProps.textEmpty),this.textFilled=this.$elTrigger.data(this.o.dataProps.textFilled),$.getScript(this.o.widgetPath,function(){t.init()}),this}e.prototype.getRecommendation=function(){var e=this;return LMDA.ajax({url:"/prism/sku-size",dataType:"json",data:{lid:LMDA.uidAny,sku:this.product.get("sku")}}).always(function(t){t&&t.status&&t.size&&e.handleSizeProposal(t.size)}),this},e.prototype.handleSizeProposal=function(e){var t=-1;return _.forEach(this.dropdown.getPossibleOptions(),function(n){n.native.indexOf(e)!==-1&&(t=n)}),t!==-1&&!this.dropdown.get()&&this.dropdown.set(t.value,!0),this},t.prototype.init=function(){var e=this;try{this.widget=new window.FitAnalyticsWidget({productId:this.formatProductId(),thumb:this.product.get("image"),language:"ru",metric:!0,error:function(t){e.handleError.apply(e,arguments)},load:function(t){e.getRecommendation(),e.reportFunnel(t)},close:function(){e.handleSizeProposal.apply(e,arguments),e.close("close")},recommend:function(){e.handleSizeProposal.apply(e,arguments)},cart:function(){e.needsCartAdding=!0,e.handleSizeProposal.apply(e,arguments),e.close("cart_add")}})}catch(t){this.handleError(),LMDA.console&&LMDA.console.error(t)}return this},t.prototype.reportFunnel=function(e){this.widget.meterExternalAB("fit analytics",{productId:e,sid:this.widget.sid})},t.prototype.close=function(e){return LMDA.Statistics.report("fitanalytics",e,{product:this.product.toJSON()}),this},t.prototype.getRecommendation=function(){return LMDA.DATA.isExperimentOn("UI7232_fitanalytics")&&(this.$elTrigger.show(),this.widget.getRecommendation(),$(".product__select-notes").find(".js-sizetable").hide()),LMDA.Statistics.report("fitanalytics","show",{product:this.product.toJSON()}),this},t.prototype.updateMatchedOption=function(e){var t=-1;return _.forEach(this.dropdown.getPossibleOptions(),function(n){n.native.indexOf(e)!==-1&&(t=n)}),this.matchedOption=t,this.matchedOption},t.prototype.handleSizeProposal=function(e,t){return t==="new user"?this:(this.updateMatchedOption(t),this.matchedOption===-1?(this.$elTriggerText.html(this.textEmpty),this.needsCartAdding&&(this.needsCartAdding=!1,this.dropdown.show()),this):(this.$elTriggerText.html(this.textFilled.replace("{size}",["<b>",this.matchedOption.text,"</b>"].join(""))),this.matchedOption.disabled&&this.needsCartAdding?(this.needsCartAdding=!1,this.dropdown.views.buy.views.notify.open(),this):(this.dropdown.set(this.matchedOption.value,!0),this.needsCartAdding&&(this.needsCartAdding=!1,this.dropdown.views.buy.add(this.dropdown.views.buy.get())),LMDA.Statistics.report("fitanalytics","get_size",{product:this.product.toJSON(),size:t}),this)))},t.prototype.handleError=function(){return this.$elTrigger.hide(),this},t.prototype.formatProductId=function(e){return["lamoda",e||this.product.get("sku")].join("-").toLowerCase()};var n=LMDA.Views.BaseView.extend({defaults:{evt:LMDA.Utils.getEventsNamesMap("DropdownPriceView"),sel:{wrapper:".ii-select__wrapper",elTrigger:".ii-select__value",dropdown:".ii-select__dropdown",options:".ii-select__options",option:".ii-select__option",badge:".ii-select__badge",notes:".ii-select__notes",notify:".js-widget-notify"},cn:{visible:"ii-select_opened",disabled:"ii-select_disabled",selected:"ii-select_selected",optionDisabled:"ii-select__option_disabled",optionSelected:"ii-select__option_selected",optionHovered:"ii-select__option_hovered",optionLast:"ii-select__option_last"},text:{placeholder:"Выберите размер",outOfStock:"Товара нет в наличии"},dataProps:{optionValue:"value",optionDisplay:"display",optionBrandSizeSystem:"bss",optionNativeSizeSystem:"nss",placeholder:"dict-placeholder",outOfStock:"dict-out_of_stock"},suggest:{prismIsUsed:!0,fitAnalyticsIsUses:!0},format:{value:function(e){var t=_.indexOf(e,"(");return t!==-1?["<b>",e.slice(0,t-1),"</b> ",e.slice(t)].join(""):e}}},initialize:function(){return!this.options.$container||!this.options.$container.length?this:(this.$container=this.options.$container,this.init&&this.init(),this)},init:function(){var n=this,r,i;return this.views.buy=this.o.widgetBuy,this.product=this.o.product,this.$wrapper=this.$container.find(this.o.sel.wrapper),this.$elTrigger=this.$wrapper.find(this.o.sel.elTrigger),this.$dropdown=this.$container.find(this.o.sel.dropdown),this.$options=this.$dropdown.find(this.o.sel.options),this.$notes=this.$dropdown.find(this.o.sel.notes),this.$badge=this.$wrapper.find(this.o.sel.badge),this.$optionsEls=this.$options.find(this.o.sel.option),this.enabled=!0,this.value=this.o.value||null,this.$selectedOptions=$(),this.value&&(this.$selectedOptions=this.getOptionsByValue(this.value),this.$selectedOptions.length&&this.selectOption(this.$selectedOptions)),this.o.text.placeholder=this.$container.data(this.o.dataProps.placeholder)||this.o.text.placeholder,this.o.text.outOfStock=this.$container.data(this.o.dataProps.outOfStock)||this.o.text.outOfStock,this.elTrigger=this.$elTrigger.get(0),this.elOptions=this.$options.get(0),this.$optionsEls.length>10&&this.$options.on("mousewheel DOMMouseScroll touchmove",function(e){var t=e.deltaY||e.wheelDeltaY||e.detail,r=n.$options.scrollTop(),i=n.elOptions.scrollHeight-n.$options.height();return t<0&&r<=0?(n.elOptions.scrollTop=0,!1):t+r>=i?(n.elOptions.scrollTop=i,!1):!0}),this.$notes.on(this.o.evt.click,function(){n.hide()}),this.$elTrigger.on(this.o.evt.click,function(){n.onClickTrigger.apply(n,arguments)}),this.$optionsEls.on(this.o.evt.click,function(){n.onClickOption.apply(n,arguments)}).on(this.o.evt.mouseenter,function(){n.onMouseenterOption.apply(n,arguments)}),r=!LMDA.DATA.isExperimentOn("prism_sku_size_off")&&this.o.suggest.prismIsUsed,r&&new e(this),i=LMDA.site==="ru"&&this.o.suggest.fitAnalyticsIsUses,i&&new t(this),this},getRelatedOption:function(e){return this.getOptionsByValue(e.data(this.o.dataProps.optionValue))},getSelectedOptions:function(){return this.$selectedOptions},getOptionsByValue:function(e){if(_.isEmpty(e))return[];var t=this;return this.$optionsEls.filter(function(){return $(this).data(t.o.dataProps.optionValue)===e})},getEnabledOptions:function(){var e=this;return this.$optionsEls.filter(function(){return!$(this).hasClass(e.o.cn.optionDisabled)})},getPossibleOptions:function(){var e=this;return _.map(this.$optionsEls,function(t){var n=$(t),r=n.data(e.o.dataProps.optionDisplay);return{el:n,disabled:n.hasClass(e.o.cn.optionDisabled),value:n.data(e.o.dataProps.optionValue),text:r,"native":""+(n.data(e.o.dataProps.optionNativeSizeSystem)||n.text()),brand:""+(n.data(e.o.dataProps.optionBrandSizeSystem)||n.text())}})},getOptions:function(){return this.$optionsEls},selectOption:function(e){return this.$optionsEls.removeClass([this.o.cn.optionSelected,this.o.cn.optionHovered].join(" ")),e.addClass(this.o.cn.optionSelected),this.$badge[e.hasClass(this.o.cn.optionLast)?"show":"hide"](),this},disableOption:function(e){var t=["data-",this.o.dataProps.optionValue].join("");return this.available-=1,this.$optionsEls.filter(function(n){return this.getAttribute(t)===e}).removeClass(this.o.cn.optionSelected).addClass(this.o.cn.optionDisabled),this},get:function(){return this.value},set:function(e,t){if(e===this.value)return this;this.$selectedOptions=this.getOptionsByValue(e);if(this.$selectedOptions.length&&this.$selectedOptions.hasClass(this.o.cn.optionDisabled))return this;this.value=e;var n=this,r="";return!e||!this.$selectedOptions.length?(this.$badge.hide(),r=this.o.text.placeholder,this.$container.removeClass(this.o.cn.selected)):(this.selectOption(this.$selectedOptions),r=this.$selectedOptions.data(this.o.dataProps.optionDisplay),r=this.o.format.value(r),this.$container.addClass(this.o.cn.selected)),this.elTrigger.innerHTML=r,this.trigger("change",this.value),LMDA.Statistics.report("product","sizeChanged",{size_id:e,sku:this.product.get("sku"),isAuto:t}),this},disable:function(){return this.elTrigger.innerHTML=this.o.text.outOfStock,this.$container.addClass(this.o.cn.disabled),this.enabled=!1,this.trigger("disabled"),this},unsetValue:function(){return this.set("")},toggle:function(){return this[this.isVisible?"hide":"show"]()},hide:function(){return this.isVisible?(this.$optionsEls.removeClass(this.o.cn.optionHovered),this.$container.removeClass(this.o.cn.visible),this.isVisible=!1,this._offOutsideClick(this.$wrapper,this.hide,this),this):this},show:function(e){if(this.isVisible)return this;this.$container.addClass(this.o.cn.visible),this.isVisible=!0,this._onOutsideClick(this.$wrapper,this.hide,this);var t=this.$selectedOptions||this.getEnabledOptions();try{t&&t.length&&(this.elOptions.scrollTop=Math.max(0,t.first().get(0).offsetTop-80))}catch(n){}return LMDA.Statistics.report("product","sizeOpen",{isAuto:e,sku:this.product.get("sku")}),this},onClickTrigger:function(e){return e&&e.preventDefault(),this.toggle(),!1},onClickOption:function(e){e&&e.preventDefault();var t=$(e.currentTarget);return t.hasClass(this.o.cn.optionDisabled)||t.hasClass(this.o.cn.optionSelected)?!1:(this.set(t.data(this.o.dataProps.optionValue)),this.hide(),!1)},onMouseenterOption:function(e){this.$optionsEls.removeClass(this.o.cn.optionHovered);var t=$(e.currentTarget);if(t.hasClass(this.o.cn.optionDisabled)||t.hasClass(this.o.cn.optionSelected))return!1;t.addClass(this.o.cn.optionHovered);var n=this.getRelatedOption(t);n.length&&n.addClass(this.o.cn.optionHovered)}});return _.extend(n.prototype,LMDA.mixins.OutsideClick),n}),define("ii/product/post-cart-recommended",["ii/product/dropdownPrice"],function(e){"use strict";return LMDA.Views.BaseView.extend({defaults:{sel:{btnAddToCart:".post-cart-add__basket.button_blue",btnAddedToCart:".post-cart-add__basket.button_green",dropdownPrice:".ii-select",dropdownPriceContainer:".product__sizes-select-container"},cn:{btnAddToCartDisabled:"button_disabled",btnAddToCartLoading:"button_disabled button_inprogress",hidden:"hidden"}},initialize:function(){return!this.o.$container||!this.o.$container.length?this:(this.$container=this.o.$container,this.init&&this.init(),this)},init:function(){var t=this;this.addFromElement=this.o.addFromElement||"",this.product=new Backbone.Model(_.extend(this.o.product,{selectedSizeSku:!1,value:""})),this.hasSizes=this.product.get("sizes").length,this.$btnAddToCart=this.$container.find(this.o.sel.btnAddToCart),this.$btnAddedToCart=this.$container.find(this.o.sel.btnAddedToCart),this.$dropdownPriceContainer=this.$container.find(this.o.sel.dropdownPriceContainer),this.$btnAddToCart.on("click",function(){t.onClickBtnAddToCart.apply(t,arguments)});if(this.hasSizes){var n=this.$container.find(this.o.sel.dropdownPrice);this.dropDownView=(new e({$container:n,product:this.product,availableSizes:this.product.get("num_available_sizes"),value:this.product.get("value"),widgetBuy:"",suggest:{prismIsUsed:!1,fitAnalyticsIsUses:!1}})).on("change",function(e){t.product.set("selectedSizeSku",e)})}},onClickBtnAddToCart:function(e){e&&e.preventDefault();var t=this.getValue();return t&&this.add(t),!1},getValue:function(){var e=this.product.get("no_size"),t=this.product.get("selectedSizeSku");return!t&&this.hasSizes?(this.dropDownView.show(),!1):t||e},add:function(e){var t=this;return this.$btnAddToCart.hasClass(this.o.cn.btnAddToCartDisabled)?!1:(this.$btnAddToCart.addClass(this.o.cn.btnAddToCartLoading),$.when(LMDA.API.Cart.addToCart(e,{addFromElement:this.addFromElement})).always(function(){t.$btnAddToCart.removeClass(t.o.cn.btnAddToCartLoading),t.$dropdownPriceContainer.addClass(t.o.cn.hidden)}).done(function(){t.$btnAddToCart.addClass(t.o.cn.hidden),t.$btnAddedToCart.removeClass(t.o.cn.hidden)}).fail(function(){t.$btnAddToCart.addClass(t.o.cn.btnAddToCartDisabled)}))}})});